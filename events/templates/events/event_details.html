{% extends 'base.html' %}
{% load static %}
{% load countries %}
{% load i18n %}

{# META INFORMATION #}
{% block meta_description %}
{{ event.title }} - {{ event.event_type }} in {{ event.location.city }}, {{ event.location.country.name }}. {{ event.description|truncatewords:25 }}
{% endblock %}

{% block content %}
<div class="min-h-screen bg-base-300">
  {# UNPUBLISHED EVENT WARNING #}
  {% if not event.published %}
    {% include "events/partials/_unpublished_warning.html" %}
  {% endif %}

  {# HERO SECTION #}
  <div class="hero bg-base-200">
    <div class="max-w-[900px] w-full mx-auto">
      <div class="hero-content p-0">
        <div class="w-full aspect-video">
          <img 
            src="{% if event.cover_image %}{{ event.cover_image.url }}{% else %}{% static 'images/sdh-bg-wpopo-100q.webp' %}{% endif %}" 
            class="w-full h-100 object-cover" 
            alt="{{ event.title|default:'Default' }} Event Cover"
          >
        </div>
      </div>
    </div>
  </div>

  {# MAIN CONTENT CONTAINER #}
  <div class="max-w-[1100px] mx-auto px-1 -mt-5 mb-20">
    <div class="card bg-base-100 shadow-xl">
      <div class="card-body px-2 py-2 sm:py-4 px-1 sm:px-4">
        {# EVENT HEADER #}
        <div class="flex flex-col lg:flex-row justify-between items-start gap-4">
          <div>
            <h1 class="card-title text-3xl font-bold mb-2">
              {{ event.title }}
            </h1>
            <div class="flex gap-2 mb-2">
              {% if not event.published %}
              <div class="badge badge-warning gap-2">
                <i class="fas fa-eye-slash"></i>
                Unpublished
              </div>
              {% endif %}
              <div class="badge badge-primary">{{ event.event_type }}</div>
              <div class="badge badge-secondary">{{ event.skill_level }}</div>
            </div>
          </div>
          
          {# ACTION BUTTONS #}
          <div class="card-actions justify-end">
            {% include "events/partials/_event_actions.html" %}
            {% if user.is_authenticated and event.organizer == user.profile %}
              <div class="dropdown dropdown-end">
                <div tabindex="0" role="button" class="btn btn-neutral">Manage Event</div>
                <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow bg-base-100 rounded-box w-52">
                  <li><a href="{% url 'events:edit_event' event.slug %}">Edit Event</a></li>
                  <li><a href="{% url 'results:upload_results' event.id %}">Upload Results</a></li>
                </ul>
              </div>
            {% endif %}
          </div>
        </div>

        {# EVENT DESCRIPTION #}
        <div class="prose max-w-none mt-4 px-2">
          {{ event.description|linebreaks }}
        </div>

        {# EVENT STATS #}
        <div class="stats stats-vertical lg:stats-horizontal shadow bg-base-200 mt-4">
          {% include "events/partials/_event_stats.html" %}
          {% if event.league %}
          <div class="stat">
            <div class="stat-title">League</div>
            <div class="stat-value text-primary">
              <a href="{% url 'results:league_standings' event.league.slug %}" class="link link-hover">
                {{ event.league.name }}
              </a>
            </div>
            <div class="stat-desc">{{ event.get_event_class_display }}</div>
          </div>
          {% endif %}
        </div>

        {# EVENT DETAILS GRID #}
        <div class="divider"></div>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          {# SCHEDULE CARD #}
          <div class="card bg-base-200">
            <div class="card-body p-4">
              {% include "events/partials/_schedule_info.html" %}
            </div>
          </div>

          {# LOCATION CARD #}
          <div class="card bg-base-200">
            <div class="card-body p-4">
              {% include "events/partials/_location_info.html" %}
            </div>
          </div>
        </div>

        {# RESULTS SECTION #}
        {% if event.has_results %}
        <div class="divider"></div>
        <div class="card bg-base-200 mt-4">
          <div class="card-body px-2">
            <h2 class="card-title">Results</h2>
            
            {% if event.has_time_trial_results %}
            <div class="mb-4">
                <h3 class="text-lg font-semibold">Time Trial Results</h3>
                {% with result=event.get_time_trial_results %}
                    {% include "results/partials/_time_trial_results.html" %}
                {% endwith %}
            </div>
            {% endif %}
            
            {% if event.has_knockout_results %}
            <div class="mb-4">
                <h3 class="text-lg font-semibold">Knockout Results</h3>
                {% with knockout_result=event.results.knockout_results.first %}
                    {% include "results/partials/_knockout_results.html" with result=knockout_result only %}
                {% endwith %}
            </div>
            {% endif %}
            
            <div class="card-actions justify-end">
                <a href="{% url 'results:view_results' event.id %}" class="btn btn-primary">
                    View Full Results
                </a>
            </div>
          </div>
        </div>
        {% endif %}

        {% if user.profile == event.organizer and not event.has_results %}
        <div class="mt-4">
          <a href="{% url 'results:upload_results' event.id %}" class="btn btn-primary">
            Upload Results
          </a>
        </div>
        {% endif %}

        {# ORGANIZER PROFILE #}
        {% include "events/partials/_organizer_profile.html" %}
        
      </div>
    </div>
  </div>
</div>

{# SCRIPTS AND RESOURCES #}
{% if user.is_authenticated %}
  <script src="{% static 'js/event_interactions.js' %}"></script>
{% endif %}

{% csrf_token %}
{% endblock %}
