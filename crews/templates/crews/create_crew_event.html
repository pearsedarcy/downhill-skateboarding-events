<!-- Enhanced Event Creation for Crews -->
{% extends "base.html" %}
{% load static %}

{% block title %}Create Event for {{ crew.name }}{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Crew Context Header -->
    <div class="mb-8">
        <div class="flex items-center space-x-4 mb-4">
            <div class="avatar">
                <div class="w-12 h-12 rounded-lg">
                    {% if crew.logo %}
                        <img src="{{ crew.logo.url }}" alt="{{ crew.name }}">
                    {% else %}
                        <div class="bg-primary/20 flex items-center justify-center h-full">
                            <i class="fas fa-users text-primary"></i>
                        </div>
                    {% endif %}
                </div>
            </div>
            <div>
                <h1 class="text-2xl font-bold">Create Event for {{ crew.name }}</h1>
                <p class="text-sm opacity-70">
                    You're creating an event on behalf of {{ crew.name }}
                    {% if crew.is_verified %}
                    <i class="fas fa-check-circle text-success ml-1"></i>
                    {% endif %}
                </p>
            </div>
        </div>
        
        <!-- Permission Notice -->
        <div class="alert alert-info">
            <i class="fas fa-info-circle"></i>
            <div>
                <h3 class="font-bold">Creating as {{ crew.name }}</h3>
                <div class="text-sm">
                    This event will be associated with {{ crew.name }} and visible on the crew's event list.
                    {% if user_membership.has_event_permission.publish %}
                    You can publish this event immediately.
                    {% else %}
                    This event will be created as a draft and require approval before publishing.
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced Event Form -->
    <form method="post" enctype="multipart/form-data" class="space-y-6" id="crew-event-form">
        {% csrf_token %}
        <input type="hidden" name="crew_id" value="{{ crew.id }}">
        
        <!-- Event Basics -->
        <div class="card bg-base-100 shadow-xl">
            <div class="card-body">
                <h2 class="card-title">
                    <i class="fas fa-calendar-alt text-primary"></i>
                    Event Details
                </h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Event Name -->
                    <div class="form-control">
                        <label class="label" for="{{ form.name.id_for_label }}">
                            <span class="label-text font-semibold">Event Name *</span>
                        </label>
                        {{ form.name }}
                        {% if form.name.errors %}
                            <label class="label">
                                <span class="label-text-alt text-error">{{ form.name.errors.0 }}</span>
                            </label>
                        {% endif %}
                    </div>
                    
                    <!-- Event Type -->
                    <div class="form-control">
                        <label class="label" for="{{ form.event_type.id_for_label }}">
                            <span class="label-text font-semibold">Event Type *</span>
                        </label>
                        {{ form.event_type }}
                        {% if form.event_type.errors %}
                            <label class="label">
                                <span class="label-text-alt text-error">{{ form.event_type.errors.0 }}</span>
                            </label>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Description -->
                <div class="form-control">
                    <label class="label" for="{{ form.description.id_for_label }}">
                        <span class="label-text font-semibold">Description</span>
                    </label>
                    {{ form.description }}
                    {% if form.description.errors %}
                        <label class="label">
                            <span class="label-text-alt text-error">{{ form.description.errors.0 }}</span>
                        </label>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Date & Location -->
        <div class="card bg-base-100 shadow-xl">
            <div class="card-body">
                <h2 class="card-title">
                    <i class="fas fa-map-marker-alt text-success"></i>
                    When & Where
                </h2>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <!-- Start Date -->
                    <div class="form-control">
                        <label class="label" for="{{ form.start_date.id_for_label }}">
                            <span class="label-text font-semibold">Start Date *</span>
                        </label>
                        {{ form.start_date }}
                        {% if form.start_date.errors %}
                            <label class="label">
                                <span class="label-text-alt text-error">{{ form.start_date.errors.0 }}</span>
                            </label>
                        {% endif %}
                    </div>
                    
                    <!-- End Date -->
                    <div class="form-control">
                        <label class="label" for="{{ form.end_date.id_for_label }}">
                            <span class="label-text font-semibold">End Date</span>
                        </label>
                        {{ form.end_date }}
                        {% if form.end_date.errors %}
                            <label class="label">
                                <span class="label-text-alt text-error">{{ form.end_date.errors.0 }}</span>
                            </label>
                        {% endif %}
                    </div>
                    
                    <!-- Registration Deadline -->
                    <div class="form-control">
                        <label class="label" for="{{ form.registration_deadline.id_for_label }}">
                            <span class="label-text font-semibold">Registration Deadline</span>
                        </label>
                        {{ form.registration_deadline }}
                        {% if form.registration_deadline.errors %}
                            <label class="label">
                                <span class="label-text-alt text-error">{{ form.registration_deadline.errors.0 }}</span>
                            </label>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Location Fields -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="form-control">
                        <label class="label" for="{{ form.location.id_for_label }}">
                            <span class="label-text font-semibold">Location *</span>
                        </label>
                        {{ form.location }}
                        {% if form.location.errors %}
                            <label class="label">
                                <span class="label-text-alt text-error">{{ form.location.errors.0 }}</span>
                            </label>
                        {% endif %}
                    </div>
                    
                    <div class="form-control">
                        <label class="label" for="{{ form.country.id_for_label }}">
                            <span class="label-text font-semibold">Country *</span>
                        </label>
                        {{ form.country }}
                        {% if form.country.errors %}
                            <label class="label">
                                <span class="label-text-alt text-error">{{ form.country.errors.0 }}</span>
                            </label>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Registration & Settings -->
        <div class="card bg-base-100 shadow-xl">
            <div class="card-body">
                <h2 class="card-title">
                    <i class="fas fa-cog text-warning"></i>
                    Event Settings
                </h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Registration Settings -->
                    <div class="space-y-4">
                        <h3 class="font-semibold">Registration</h3>
                        
                        <div class="form-control">
                            <label class="label" for="{{ form.max_participants.id_for_label }}">
                                <span class="label-text">Maximum Participants</span>
                            </label>
                            {{ form.max_participants }}
                            {% if form.max_participants.errors %}
                                <label class="label">
                                    <span class="label-text-alt text-error">{{ form.max_participants.errors.0 }}</span>
                                </label>
                            {% endif %}
                        </div>
                        
                        <div class="form-control">
                            <label class="cursor-pointer label">
                                {{ form.registration_required }}
                                <span class="label-text">Require Registration</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Publishing Options -->
                    <div class="space-y-4">
                        <h3 class="font-semibold">Publishing</h3>
                        
                        {% if user_membership.has_event_permission.publish %}
                        <div class="form-control">
                            <label class="cursor-pointer label">
                                <input type="checkbox" name="publish_immediately" class="checkbox checkbox-primary" checked>
                                <span class="label-text">Publish immediately</span>
                            </label>
                            <label class="label">
                                <span class="label-text-alt">You can publish this event right away</span>
                            </label>
                        </div>
                        {% else %}
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i>
                            <div>
                                <h4 class="font-bold">Requires Approval</h4>
                                <div class="text-sm">
                                    This event will be saved as a draft and require approval from a crew admin before publishing.
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Action Buttons -->
        <div class="flex flex-col sm:flex-row gap-4 justify-between">
            <a href="{% url 'crews:crew_detail' crew.slug %}" class="btn btn-outline">
                <i class="fas fa-arrow-left mr-2"></i>
                Back to {{ crew.name }}
            </a>
            
            <div class="flex gap-2">
                <button type="submit" name="action" value="save_draft" class="btn btn-outline">
                    <i class="fas fa-save mr-2"></i>
                    Save as Draft
                </button>
                
                {% if user_membership.has_event_permission.publish %}
                <button type="submit" name="action" value="publish" class="btn btn-primary">
                    <i class="fas fa-rocket mr-2"></i>
                    Create & Publish
                </button>
                {% else %}
                <button type="submit" name="action" value="submit_for_approval" class="btn btn-primary">
                    <i class="fas fa-paper-plane mr-2"></i>
                    Submit for Approval
                </button>
                {% endif %}
            </div>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Auto-populate end date when start date changes
    const startDateInput = document.querySelector('#id_start_date');
    const endDateInput = document.querySelector('#id_end_date');
    
    if (startDateInput && endDateInput) {
        startDateInput.addEventListener('change', function() {
            if (!endDateInput.value && this.value) {
                endDateInput.value = this.value;
            }
        });
    }
    
    // Auto-populate registration deadline (day before start date)
    const regDeadlineInput = document.querySelector('#id_registration_deadline');
    
    if (startDateInput && regDeadlineInput) {
        startDateInput.addEventListener('change', function() {
            if (!regDeadlineInput.value && this.value) {
                const startDate = new Date(this.value);
                startDate.setDate(startDate.getDate() - 1);
                regDeadlineInput.value = startDate.toISOString().split('T')[0];
            }
        });
    }
});
</script>
{% endblock %}
