{% extends "base.html" %}
{% load static %}

{% block title %}{{ crew.name }} - Crews{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Crew Header -->
    <div class="mb-8">
        {% if crew.banner %}
        <div class="h-48 md:h-64 bg-gradient-to-br from-primary/20 to-secondary/20 rounded-lg overflow-hidden mb-6">
            <img src="{{ crew.banner.url }}" alt="{{ crew.name }} banner" 
                 class="w-full h-full object-cover">
        </div>
        {% endif %}
        
        <div class="flex flex-col md:flex-row items-start md:items-center gap-6">
            <!-- Logo -->
            <div class="avatar">
                <div class="w-24 h-24 rounded-xl bg-base-200">
                    {% if crew.logo %}
                        <img src="{{ crew.logo.url }}" alt="{{ crew.name }} logo">
                    {% else %}
                        <div class="flex items-center justify-center h-full">
                            <i class="fas fa-users text-3xl text-primary/40"></i>
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Crew Info -->
            <div class="flex-1">
                <div class="flex items-center gap-3 mb-2">
                    <h1 class="text-4xl font-bold text-base-content">{{ crew.name }}</h1>
                    {% if crew.is_verified %}
                    <div class="badge badge-success gap-1">
                        <i class="fas fa-check text-xs"></i>
                        Verified
                    </div>
                    {% endif %}
                </div>
                
                <div class="flex flex-wrap gap-2 mb-3">
                    <div class="badge badge-primary">{{ crew.get_crew_type_display }}</div>
                    <div class="badge badge-outline">{{ crew.get_primary_discipline_display }}</div>
                    {% if crew.city and crew.country %}
                    <div class="badge badge-outline">
                        <i class="fas fa-map-marker-alt mr-1"></i>
                        {{ crew.city }}, {{ crew.country.name }}
                    </div>
                    {% endif %}
                </div>
                
                <div class="flex items-center gap-4 text-sm text-base-content/70">
                    <span>
                        <i class="fas fa-user mr-1"></i>
                        {{ crew.member_count }} member{{ crew.member_count|pluralize }}
                    </span>
                    <span>
                        <i class="fas fa-calendar mr-1"></i>
                        Created {{ crew.created_at|date:"M Y" }}
                    </span>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex flex-col sm:flex-row gap-2">
                {% if user.is_authenticated %}
                    {% if can_manage %}
                        <div class="dropdown dropdown-end">
                            <div tabindex="0" role="button" class="btn btn-primary">
                                <i class="fas fa-cog mr-2"></i>
                                Manage Crew
                                <i class="fas fa-chevron-down ml-1"></i>
                            </div>
                            <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow bg-base-100 rounded-box w-52">
                                <li>
                                    <a href="{% url 'crews:edit' crew.slug %}">
                                        <i class="fas fa-edit mr-2"></i>
                                        Edit Crew Details
                                    </a>
                                </li>
                                <li>
                                    <a href="{% url 'crews:manage_permissions' crew.slug %}">
                                        <i class="fas fa-user-shield mr-2"></i>
                                        Manage Permissions
                                    </a>
                                </li>
                                <li>
                                    <a href="{% url 'crews:invite' crew.slug %}">
                                        <i class="fas fa-user-plus mr-2"></i>
                                        Invite Members
                                    </a>
                                </li>
                            </ul>
                        </div>
                        <a href="{% url 'crews:members' crew.slug %}" class="btn btn-outline">
                            <i class="fas fa-users mr-2"></i>
                            Members ({{ crew.memberships.count }})
                        </a>
                    {% else %}
                        <a href="{% url 'crews:members' crew.slug %}" class="btn btn-outline">
                            <i class="fas fa-users mr-2"></i>
                            View Members ({{ crew.memberships.count }})
                        </a>
                        <a href="{% url 'crews:join' crew.slug %}" class="btn btn-primary">
                            <i class="fas fa-user-plus mr-2"></i>
                            Join Crew
                        </a>
                    {% endif %}
                {% else %}
                    <a href="{% url 'crews:members' crew.slug %}" class="btn btn-outline">
                        <i class="fas fa-users mr-2"></i>
                        View Members ({{ crew.memberships.count }})
                    </a>
                    <a href="{% url 'account_login' %}" class="btn btn-primary">
                        <i class="fas fa-sign-in-alt mr-2"></i>
                        Login to Join
                    </a>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Crew Description -->
    {% if crew.description %}
    <div class="card bg-base-100 shadow-lg mb-8">
        <div class="card-body">
            <h2 class="card-title">
                <i class="fas fa-info-circle text-primary mr-2"></i>
                About {{ crew.name }}
            </h2>
            <div class="prose max-w-none">
                {{ crew.description|linebreaks }}
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Navigation Tabs -->
    <div class="tabs tabs-bordered mb-6">
        <a class="tab tab-active" data-tab="members">Members</a>
        <a class="tab" data-tab="events">Events ({{ total_events }})</a>
        <a href="{% url 'crews:activity' crew.slug %}" class="tab">Activity</a>
    </div>
    
    <!-- Members Section -->
    <div class="card bg-base-100 shadow-lg" id="members-tab">
        <div class="card-body">
            <div class="flex items-center justify-between mb-6">
                <h2 class="card-title">
                    <i class="fas fa-users text-primary mr-2"></i>
                    Crew Members ({{ crew.member_count }})
                </h2>
                
                {% if can_manage %}
                <div class="flex gap-2">
                    <a href="{% url 'crews:manage_permissions' crew.slug %}" class="btn btn-outline btn-sm">
                        <i class="fas fa-user-shield mr-2"></i>
                        Permissions
                    </a>
                    <a href="{% url 'crews:invite' crew.slug %}" class="btn btn-secondary btn-sm">
                        <i class="fas fa-user-plus mr-2"></i>
                        Invite Members
                    </a>
                </div>
                {% endif %}
            </div>
            
            <!-- Members List -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                {% for membership in active_memberships %}
                <div class="flex items-center gap-3 p-3 rounded-lg border border-base-300">
                    <div class="avatar">
                        <div class="w-12 h-12 rounded-full bg-primary/20">
                            {% if membership.user.userprofile.profile_picture %}
                                <img src="{{ membership.user.userprofile.profile_picture.url }}" 
                                     alt="{{ membership.user.username }}">
                            {% else %}
                                <div class="flex items-center justify-center h-full">
                                    <i class="fas fa-user text-primary/60"></i>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="flex-1">
                        <div class="font-medium">
                            {% if membership.nickname %}
                                {{ membership.nickname }}
                                <span class="text-sm text-base-content/60">({{ membership.user.username }})</span>
                            {% else %}
                                {{ membership.user.username }}
                            {% endif %}
                        </div>
                        <div class="text-sm text-base-content/60">{{ membership.get_role_display }}</div>
                    </div>
                    
                    {% if membership.role == 'OWNER' %}
                    <div class="badge badge-warning text-xs">Owner</div>
                    {% elif membership.role == 'ADMIN' %}
                    <div class="badge badge-info text-xs">Admin</div>
                    {% endif %}
                </div>
                {% empty %}
                <div class="col-span-full text-center py-8 text-base-content/60">
                    No members found.
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    
    <!-- Events Section -->
    <div class="card bg-base-100 shadow-lg hidden" id="events-tab">
        <div class="card-body">
            <div class="flex items-center justify-between mb-6">
                <h2 class="card-title">
                    <i class="fas fa-calendar text-primary mr-2"></i>
                    Crew Events ({{ total_events }})
                </h2>
                
                {% if user_permissions.create or user_permissions.manage_crew %}
                <a href="{% url 'events:submit' %}?crew={{ crew.slug }}" class="btn btn-secondary btn-sm">
                    <i class="fas fa-plus mr-2"></i>
                    Create Event
                </a>
                {% endif %}
            </div>
            
            {% if upcoming_events or past_events %}
                <!-- Upcoming Events -->
                {% if upcoming_events %}
                <div class="mb-8">
                    <h3 class="text-lg font-semibold mb-4 flex items-center">
                        <i class="fas fa-arrow-up text-success mr-2"></i>
                        Upcoming Events ({{ upcoming_events.count }})
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        {% for event in upcoming_events %}
                        <div class="card bg-base-200 shadow-sm border border-base-300">
                            <div class="card-body p-4">
                                <div class="flex items-start justify-between mb-2">
                                    <h4 class="card-title text-base">
                                        <a href="{% url 'events:event_details' event.slug %}" class="link link-hover">
                                            {{ event.title }}
                                        </a>
                                    </h4>
                                    <div class="flex items-center gap-2">
                                        <!-- Published status badge -->
                                        {% if event.published %}
                                            <div class="badge badge-success badge-sm">Published</div>
                                        {% else %}
                                            <div class="badge badge-warning badge-sm">Draft</div>
                                        {% endif %}
                                        <div class="badge badge-ghost badge-sm">{{ event.get_event_class_display }}</div>
                                        
                                        <!-- Management dropdown for users with appropriate permissions -->
                                        {% if event.user_can_manage %}
                                        <div class="dropdown dropdown-end">
                                            <div tabindex="0" role="button" class="btn btn-ghost btn-xs">
                                                <i class="fas fa-ellipsis-v"></i>
                                            </div>
                                            <ul tabindex="0" class="dropdown-content menu bg-base-100 rounded-box z-[1] w-48 p-2 shadow border">
                                                <li>
                                                    <a href="{% url 'events:edit_event' event.slug %}" class="text-sm">
                                                        <i class="fas fa-edit"></i>
                                                        Edit Event
                                                    </a>
                                                </li>
                                                <!-- Show publish/unpublish based on user permission -->
                                                {% if event.user_can_publish %}
                                                <li>
                                                    <a href="#" class="text-sm toggle-publish-btn" data-slug="{{ event.slug }}" data-published="{{ event.published|yesno:'true,false' }}">
                                                        {% if event.published %}
                                                            <i class="fas fa-eye-slash"></i>
                                                            Unpublish
                                                        {% else %}
                                                            <i class="fas fa-eye"></i>
                                                            Publish
                                                        {% endif %}
                                                    </a>
                                                </li>
                                                {% endif %}
                                                <li><hr class="border-base-300 my-1"></li>
                                                <li>
                                                    <a href="#" class="text-sm text-error delete-event-btn" data-slug="{{ event.slug }}" data-title="{{ event.title }}">
                                                        <i class="fas fa-trash"></i>
                                                        Delete Event
                                                    </a>
                                                </li>
                                            </ul>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="text-sm text-base-content/70 space-y-1">
                                    <div class="flex items-center">
                                        <i class="fas fa-calendar-day w-4 mr-2"></i>
                                        {{ event.start_date|date:"M d, Y" }}
                                        {% if event.end_date and event.end_date != event.start_date %}
                                            - {{ event.end_date|date:"M d, Y" }}
                                        {% endif %}
                                    </div>
                                    {% if event.location %}
                                    <div class="flex items-center">
                                        <i class="fas fa-map-marker-alt w-4 mr-2"></i>
                                        {{ event.location.city }}, {{ event.location.country.name }}
                                    </div>
                                    {% endif %}
                                    <div class="flex items-center">
                                        <i class="fas fa-tag w-4 mr-2"></i>
                                        {{ event.event_type }}
                                    </div>
                                </div>
                                
                                {% if event.description %}
                                <p class="text-sm text-base-content/60 mt-2 line-clamp-2">
                                    {{ event.description|truncatewords:20 }}
                                </p>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                
                <!-- Past Events -->
                {% if past_events %}
                <div>
                    <h3 class="text-lg font-semibold mb-4 flex items-center">
                        <i class="fas fa-history text-base-content/60 mr-2"></i>
                        Past Events ({{ past_events.count }})
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        {% for event in past_events|slice:":6" %}
                        <div class="card bg-base-200 shadow-sm border border-base-300 opacity-80">
                            <div class="card-body p-4">
                                <div class="flex items-start justify-between mb-2">
                                    <h4 class="card-title text-base">
                                        <a href="{% url 'events:event_details' event.slug %}" class="link link-hover">
                                            {{ event.title }}
                                        </a>
                                    </h4>
                                    <div class="flex items-center gap-2">
                                        <!-- Published status badge -->
                                        {% if event.published %}
                                            <div class="badge badge-success badge-sm">Published</div>
                                        {% else %}
                                            <div class="badge badge-warning badge-sm">Draft</div>
                                        {% endif %}
                                        <div class="badge badge-ghost badge-sm">{{ event.get_event_class_display }}</div>
                                        
                                        <!-- Management dropdown for users with appropriate permissions -->
                                        {% if event.user_can_manage %}
                                        <div class="dropdown dropdown-end">
                                            <div tabindex="0" role="button" class="btn btn-ghost btn-xs">
                                                <i class="fas fa-ellipsis-v"></i>
                                            </div>
                                            <ul tabindex="0" class="dropdown-content menu bg-base-100 rounded-box z-[1] w-48 p-2 shadow border">
                                                <li>
                                                    <a href="{% url 'events:edit_event' event.slug %}" class="text-sm">
                                                        <i class="fas fa-edit"></i>
                                                        Edit Event
                                                    </a>
                                                </li>
                                                <!-- Show publish/unpublish based on user permission -->
                                                {% if event.user_can_publish %}
                                                <li>
                                                    <a href="#" class="text-sm toggle-publish-btn" data-slug="{{ event.slug }}" data-published="{{ event.published|yesno:'true,false' }}">
                                                        {% if event.published %}
                                                            <i class="fas fa-eye-slash"></i>
                                                            Unpublish
                                                        {% else %}
                                                            <i class="fas fa-eye"></i>
                                                            Publish
                                                        {% endif %}
                                                    </a>
                                                </li>
                                                {% endif %}
                                                <li><hr class="border-base-300 my-1"></li>
                                                <li>
                                                    <a href="#" class="text-sm text-error delete-event-btn" data-slug="{{ event.slug }}" data-title="{{ event.title }}">
                                                        <i class="fas fa-trash"></i>
                                                        Delete Event
                                                    </a>
                                                </li>
                                            </ul>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="text-sm text-base-content/70 space-y-1">
                                    <div class="flex items-center">
                                        <i class="fas fa-calendar-day w-4 mr-2"></i>
                                        {{ event.start_date|date:"M d, Y" }}
                                    </div>
                                    {% if event.location %}
                                    <div class="flex items-center">
                                        <i class="fas fa-map-marker-alt w-4 mr-2"></i>
                                        {{ event.location.city }}, {{ event.location.country.name }}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    
                    {% if past_events.count > 6 %}
                    <div class="text-center mt-4">
                        <div class="text-sm text-base-content/60">
                            And {{ past_events.count|add:"-6" }} more past event{{ past_events.count|add:"-6"|pluralize }}...
                        </div>
                    </div>
                    {% endif %}
                </div>
                {% endif %}
            {% else %}
                <div class="text-center py-12">
                    <i class="fas fa-calendar-times text-6xl text-base-content/20 mb-4"></i>
                    <h3 class="text-xl font-semibold text-base-content/60 mb-2">No Events Yet</h3>
                    <p class="text-base-content/50 mb-4">This crew hasn't organized any events yet.</p>
                    {% if can_manage %}
                    <a href="{% url 'events:submit' %}?crew={{ crew.slug }}" class="btn btn-primary">
                        <i class="fas fa-plus mr-2"></i>
                        Create First Event
                    </a>
                    {% endif %}
                </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Social Links -->
    {% if crew.website or crew.instagram or crew.youtube %}
    <div class="card bg-base-100 shadow-lg mt-8">
        <div class="card-body">
            <h2 class="card-title">
                <i class="fas fa-link text-primary mr-2"></i>
                Connect with {{ crew.name }}
            </h2>
            
            <div class="flex flex-wrap gap-3">
                {% if crew.website %}
                <a href="{{ crew.website }}" target="_blank" rel="noopener" 
                   class="btn btn-outline btn-sm">
                    <i class="fas fa-globe mr-2"></i>
                    Website
                </a>
                {% endif %}
                
                {% if crew.instagram %}
                <a href="https://instagram.com/{{ crew.instagram }}" target="_blank" rel="noopener"
                   class="btn btn-outline btn-sm">
                    <i class="fab fa-instagram mr-2"></i>
                    @{{ crew.instagram }}
                </a>
                {% endif %}
                
                {% if crew.youtube %}
                <a href="{{ crew.youtube }}" target="_blank" rel="noopener"
                   class="btn btn-outline btn-sm">
                    <i class="fab fa-youtube mr-2"></i>
                    YouTube
                </a>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Tab switching functionality
    const tabs = document.querySelectorAll('.tab[data-tab]');
    const tabContents = {
        'members': document.getElementById('members-tab'),
        'events': document.getElementById('events-tab')
    };
    
    tabs.forEach(tab => {
        tab.addEventListener('click', function(e) {
            e.preventDefault();
            const targetTab = this.getAttribute('data-tab');
            
            // Remove active class from all tabs
            tabs.forEach(t => t.classList.remove('tab-active'));
            
            // Hide all tab contents
            Object.values(tabContents).forEach(content => {
                if (content) content.classList.add('hidden');
            });
            
            // Show selected tab content
            if (tabContents[targetTab]) {
                tabContents[targetTab].classList.remove('hidden');
            }
            
            // Add active class to clicked tab
            this.classList.add('tab-active');
        });
    });
});

// Event management functions
document.addEventListener('DOMContentLoaded', function() {
    // Handle toggle publish buttons
    document.querySelectorAll('.toggle-publish-btn').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            const eventSlug = this.dataset.slug;
            const currentState = this.dataset.published;
            togglePublish(eventSlug, currentState);
        });
    });
    
    // Handle delete event buttons
    document.querySelectorAll('.delete-event-btn').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            const eventSlug = this.dataset.slug;
            const eventTitle = this.dataset.title;
            deleteEvent(eventSlug, eventTitle);
        });
    });
});

function togglePublish(eventSlug, currentState) {
    // Create and submit a form dynamically
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = `/events/${eventSlug}/toggle-publish/`;
    
    // Add CSRF token
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    const csrfInput = document.createElement('input');
    csrfInput.type = 'hidden';
    csrfInput.name = 'csrfmiddlewaretoken';
    csrfInput.value = csrfToken;
    form.appendChild(csrfInput);
    
    document.body.appendChild(form);
    form.submit();
}

function deleteEvent(eventSlug, eventTitle) {
    if (confirm(`Are you sure you want to delete the event "${eventTitle}"?`)) {
        // Create and submit a form dynamically
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/events/${eventSlug}/delete/`;
        
        // Add CSRF token
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrfmiddlewaretoken';
        csrfInput.value = csrfToken;
        form.appendChild(csrfInput);
        
        document.body.appendChild(form);
        form.submit();
    }
}
</script>
{% endblock %}
