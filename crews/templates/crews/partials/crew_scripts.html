<!-- Image Modal -->
<dialog id="imageModal" class="modal">
    <div class="modal-box max-w-4xl">
        <form method="dialog">
            <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">âœ•</button>
        </form>
        <img id="modalImage" src="" alt="" class="w-full h-auto rounded-lg">
        <h3 id="modalTitle" class="font-bold text-lg mt-4"></h3>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>

<script>
// Image modal functionality
function openImageModal(src, title) {
    document.getElementById('modalImage').src = src;
    document.getElementById('modalTitle').textContent = title;
    document.getElementById('imageModal').showModal();
}

document.addEventListener('DOMContentLoaded', function() {
    // Set progress bar widths
    document.querySelectorAll('.role-progress-bar').forEach(bar => {
        const width = bar.getAttribute('data-width');
        bar.style.width = width + '%';
    });
    
    // Tab switching functionality
    const tabs = document.querySelectorAll('.tab[data-tab]');
    const tabContents = {
        'members': document.getElementById('members-tab'),
        'events': document.getElementById('events-tab')
    };
    
    tabs.forEach(tab => {
        tab.addEventListener('click', function(e) {
            e.preventDefault();
            const targetTab = this.getAttribute('data-tab');
            
            // Remove active class from all tabs
            tabs.forEach(t => t.classList.remove('tab-active'));
            
            // Hide all tab contents
            Object.values(tabContents).forEach(content => {
                if (content) content.classList.add('hidden');
            });
            
            // Show selected tab content
            if (tabContents[targetTab]) {
                tabContents[targetTab].classList.remove('hidden');
            }
            
            // Add active class to clicked tab
            this.classList.add('tab-active');
        });
    });
});

// Event management functions
document.addEventListener('DOMContentLoaded', function() {
    // Handle toggle publish buttons
    document.querySelectorAll('.toggle-publish-btn').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            const eventSlug = this.dataset.slug;
            const currentState = this.dataset.published;
            togglePublish(eventSlug, currentState);
        });
    });
    
    // Handle delete event buttons
    document.querySelectorAll('.delete-event-btn').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            const eventSlug = this.dataset.slug;
            const eventTitle = this.dataset.title;
            deleteEvent(eventSlug, eventTitle);
        });
    });
});

function togglePublish(eventSlug, currentState) {
    // Create and submit a form dynamically
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = `/events/${eventSlug}/publish/`;
    
    // Add CSRF token
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    const csrfInput = document.createElement('input');
    csrfInput.type = 'hidden';
    csrfInput.name = 'csrfmiddlewaretoken';
    csrfInput.value = csrfToken;
    form.appendChild(csrfInput);
    
    document.body.appendChild(form);
    form.submit();
}

// Toast notification system
function showToast(message, type = 'success') {
    // Remove existing toasts
    const existingToasts = document.querySelectorAll('.toast-notification');
    existingToasts.forEach(toast => toast.remove());
    
    // Create toast
    const toast = document.createElement('div');
    toast.className = `toast-notification toast toast-top toast-end z-50`;
    
    const alertClass = type === 'success' ? 'alert-success' : 
                      type === 'error' ? 'alert-error' : 
                      type === 'warning' ? 'alert-warning' : 'alert-info';
    
    const icon = type === 'success' ? 'fa-check-circle' : 
                 type === 'error' ? 'fa-exclamation-circle' : 
                 type === 'warning' ? 'fa-exclamation-triangle' : 'fa-info-circle';
    
    toast.innerHTML = `
        <div class="alert ${alertClass} shadow-lg">
            <i class="fas ${icon}"></i>
            <span>${message}</span>
        </div>
    `;
    
    document.body.appendChild(toast);
    
    // Auto-remove after 4 seconds
    setTimeout(() => {
        if (toast.parentNode) {
            toast.remove();
        }
    }, 4000);
}

// Update membership badge after leaving crew
function updateMembershipBadge(isNowMember, crewName, memberCount) {
    const badge = document.getElementById('membership-status-badge');
    if (!badge) return;
    
    if (isNowMember) {
        badge.innerHTML = `
            <div class="badge badge-success gap-2 text-white shadow-lg backdrop-blur-sm">
                <i class="fas fa-check text-xs"></i>
                <span class="font-medium">Member</span>
            </div>
        `;
    } else {
        badge.innerHTML = `
            <div class="badge badge-info gap-2 text-white shadow-lg backdrop-blur-sm">
                <i class="fas fa-user-plus text-xs"></i>
                <span class="font-medium">Join Crew</span>
            </div>
        `;
    }
}

// Leave crew with AJAX
async function leaveCrew(crewSlug, crewName) {
    const leaveButton = document.querySelector('.btn-error');
    const originalText = leaveButton.innerHTML;
    
    // Show loading state
    leaveButton.disabled = true;
    leaveButton.innerHTML = '<span class="loading loading-spinner loading-sm mr-2"></span>Leaving...';
    
    try {
        const response = await fetch(`/crews/${crewSlug}/leave/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            },
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Close modal
            document.getElementById('leave_crew_modal').close();
            
            // Update membership badge
            updateMembershipBadge(false, crewName, data.member_count);
            
            // Show success toast
            showToast(data.message, 'success');
            
            // Update member count in UI
            const memberCountElements = document.querySelectorAll('[data-member-count]');
            memberCountElements.forEach(el => {
                el.textContent = data.member_count;
            });
            
            // Reload page to update action buttons and membership status
            setTimeout(() => location.reload(), 1500);
        } else {
            showToast(data.message, 'error');
        }
    } catch (error) {
        showToast('An error occurred while leaving the crew. Please try again.', 'error');
    } finally {
        // Reset button state
        leaveButton.disabled = false;
        leaveButton.innerHTML = originalText;
    }
}

function deleteEvent(eventSlug, eventTitle) {
    if (confirm(`Are you sure you want to delete the event "${eventTitle}"?`)) {
        // Create and submit a form dynamically
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/events/delete/${eventSlug}/`;
        
        // Add CSRF token
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrfmiddlewaretoken';
        csrfInput.value = csrfToken;
        form.appendChild(csrfInput);
        
        document.body.appendChild(form);
        form.submit();
    }
}
</script>
