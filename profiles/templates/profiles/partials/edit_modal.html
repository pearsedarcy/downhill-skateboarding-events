<!-- Quick Edit Modal -->
<dialog id="edit-modal" class="modal">
    <div class="modal-box max-w-2xl">
        <h3 class="font-bold text-lg mb-6 flex items-center gap-2">
            <i class="fas fa-edit text-primary"></i>
            Quick Edit Profile
        </h3>
        
        <form id="quick-edit-form" class="space-y-6">
            {% csrf_token %}
            
            <!-- Basic Information -->
            <div class="card bg-base-200">
                <div class="card-body p-4">
                    <h4 class="card-title text-sm mb-4">Basic Information</h4>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Display Name -->
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Display Name</span>
                            </label>
                            <input type="text" 
                                   id="edit-display-name"
                                   value="{{ profile.display_name|default:profile.user.username }}" 
                                   class="input input-bordered input-sm" 
                                   placeholder="Your display name">
                        </div>
                        
                        <!-- Skating Style -->
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Skating Style</span>
                            </label>
                            <select id="edit-skating-style" class="select select-bordered select-sm">
                                <option value="">Select style...</option>
                                {% for value, display in skating_style_choices %}
                                    <option value="{{ value }}" {% if profile.skating_style == value %}selected{% endif %}>
                                        {{ display }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <!-- Location -->
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">City</span>
                            </label>
                            <input type="text" 
                                   id="edit-city"
                                   value="{{ profile.city }}" 
                                   class="input input-bordered input-sm" 
                                   placeholder="Your city">
                        </div>
                        
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Country</span>
                            </label>
                            <input type="text" 
                                   id="edit-country"
                                   value="{{ profile.country }}" 
                                   class="input input-bordered input-sm" 
                                   placeholder="Your country">
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Bio -->
            <div class="card bg-base-200">
                <div class="card-body p-4">
                    <h4 class="card-title text-sm mb-4">About You</h4>
                    
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Bio</span>
                            <span class="label-text-alt" id="bio-counter">{{ profile.bio|length|default:0 }}/500</span>
                        </label>
                        <textarea id="edit-bio" 
                                  class="textarea textarea-bordered h-24" 
                                  maxlength="500"
                                  placeholder="Tell us about yourself, your skating journey..."
                                  oninput="updateCharCounter('bio')">{{ profile.bio }}</textarea>
                    </div>
                </div>
            </div>
            
            <!-- Skating Profile -->
            <div class="card bg-base-200">
                <div class="card-body p-4">
                    <h4 class="card-title text-sm mb-4">Skating Profile</h4>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <!-- Skill Level -->
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Skill Level</span>
                                <span class="label-text-alt" id="skill-level-display">{{ profile.skill_level|default:5 }}/10</span>
                            </label>
                            <input type="range" 
                                   id="edit-skill-level"
                                   min="1" max="10" 
                                   value="{{ profile.skill_level|default:5 }}" 
                                   class="range range-primary range-sm"
                                   oninput="updateSkillDisplay()">
                            <div class="w-full flex justify-between text-xs px-2 mt-1">
                                <span>1</span>
                                <span>5</span>
                                <span>10</span>
                            </div>
                        </div>
                        
                        <!-- Years Skating -->
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Years Skating</span>
                            </label>
                            <input type="number" 
                                   id="edit-years-skating"
                                   value="{{ profile.years_skating }}" 
                                   class="input input-bordered input-sm" 
                                   min="0" max="100"
                                   placeholder="Years">
                        </div>
                        
                        <!-- Stance -->
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Stance</span>
                            </label>
                            <select id="edit-stance" class="select select-bordered select-sm">
                                <option value="">Select stance...</option>
                                {% for value, display in stance_choices %}
                                    <option value="{{ value }}" {% if profile.stance == value %}selected{% endif %}>
                                        {{ display }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    
                    <!-- Primary Setup -->
                    <div class="form-control mt-4">
                        <label class="label">
                            <span class="label-text">Primary Setup</span>
                            <span class="label-text-alt" id="setup-counter">{{ profile.primary_setup|length|default:0 }}/300</span>
                        </label>
                        <textarea id="edit-primary-setup" 
                                  class="textarea textarea-bordered h-20" 
                                  maxlength="300"
                                  placeholder="Describe your skateboard setup..."
                                  oninput="updateCharCounter('setup')">{{ profile.primary_setup }}</textarea>
                    </div>
                </div>
            </div>
            
            <!-- Social Links -->
            <div class="card bg-base-200">
                <div class="card-body p-4">
                    <h4 class="card-title text-sm mb-4">Social Links</h4>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <!-- Instagram -->
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text flex items-center gap-2">
                                    <i class="fab fa-instagram text-pink-500"></i>
                                    Instagram
                                </span>
                            </label>
                            <input type="text" 
                                   id="edit-instagram"
                                   value="{{ profile.instagram }}" 
                                   class="input input-bordered input-sm" 
                                   placeholder="username">
                        </div>
                        
                        <!-- YouTube -->
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text flex items-center gap-2">
                                    <i class="fab fa-youtube text-red-500"></i>
                                    YouTube
                                </span>
                            </label>
                            <input type="url" 
                                   id="edit-youtube"
                                   value="{{ profile.youtube }}" 
                                   class="input input-bordered input-sm" 
                                   placeholder="Channel URL">
                        </div>
                        
                        <!-- Website -->
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text flex items-center gap-2">
                                    <i class="fas fa-globe text-blue-500"></i>
                                    Website
                                </span>
                            </label>
                            <input type="url" 
                                   id="edit-website"
                                   value="{{ profile.website }}" 
                                   class="input input-bordered input-sm" 
                                   placeholder="Website URL">
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Privacy Settings -->
            <div class="card bg-base-200">
                <div class="card-body p-4">
                    <h4 class="card-title text-sm mb-4">Privacy Settings</h4>
                    
                    <div class="space-y-4">
                        <!-- Profile Visibility -->
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Profile Visibility</span>
                            </label>
                            <select id="edit-profile-visibility" class="select select-bordered select-sm">
                                {% for value, display in profile_visibility_choices %}
                                    <option value="{{ value }}" {% if profile.profile_visibility == value %}selected{% endif %}>
                                        {{ display }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <!-- Privacy Toggles -->
                        <div class="flex flex-wrap gap-4">
                            <div class="form-control">
                                <label class="cursor-pointer label">
                                    <span class="label-text mr-3">Show real name</span>
                                    <input type="checkbox" 
                                           id="edit-show-real-name"
                                           class="toggle toggle-primary toggle-sm" 
                                           {% if profile.show_real_name %}checked{% endif %}>
                                </label>
                            </div>
                            
                            <div class="form-control">
                                <label class="cursor-pointer label">
                                    <span class="label-text mr-3">Show location</span>
                                    <input type="checkbox" 
                                           id="edit-show-location"
                                           class="toggle toggle-primary toggle-sm" 
                                           {% if profile.show_location %}checked{% endif %}>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Save Progress -->
            <div id="save-progress" class="hidden">
                <div class="flex items-center gap-2 mb-2">
                    <span class="loading loading-spinner loading-sm"></span>
                    <span class="text-sm">Saving changes...</span>
                </div>
                <progress class="progress progress-primary w-full" value="0" max="100" id="save-progress-bar"></progress>
            </div>
        </form>
        
        <!-- Modal Actions -->
        <div class="modal-action">
            <form method="dialog">
                <button class="btn" type="button" onclick="closeEditModal()">Cancel</button>
            </form>
            <button class="btn btn-primary" onclick="saveQuickEdit()">
                <i class="fas fa-save mr-2"></i>
                Save Changes
            </button>
        </div>
    </div>
    
    <!-- Close modal when clicking outside -->
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>

<script>
// Character counter updates
function updateCharCounter(field) {
    const textarea = document.getElementById(`edit-${field === 'bio' ? 'bio' : 'primary-setup'}`);
    const counter = document.getElementById(`${field === 'bio' ? 'bio' : 'setup'}-counter`);
    const maxLength = textarea.getAttribute('maxlength');
    const currentLength = textarea.value.length;
    
    counter.textContent = `${currentLength}/${maxLength}`;
    
    // Color coding
    if (currentLength > maxLength * 0.9) {
        counter.classList.add('text-warning');
        counter.classList.remove('text-error');
    } else if (currentLength === parseInt(maxLength)) {
        counter.classList.add('text-error');
        counter.classList.remove('text-warning');
    } else {
        counter.classList.remove('text-warning', 'text-error');
    }
}

// Skill level display update
function updateSkillDisplay() {
    const slider = document.getElementById('edit-skill-level');
    const display = document.getElementById('skill-level-display');
    display.textContent = `${slider.value}/10`;
}

// Save quick edit changes
function saveQuickEdit() {
    const formData = {
        display_name: document.getElementById('edit-display-name').value,
        bio: document.getElementById('edit-bio').value,
        city: document.getElementById('edit-city').value,
        country: document.getElementById('edit-country').value,
        skating_style: document.getElementById('edit-skating-style').value,
        skill_level: document.getElementById('edit-skill-level').value,
        years_skating: document.getElementById('edit-years-skating').value,
        stance: document.getElementById('edit-stance').value,
        primary_setup: document.getElementById('edit-primary-setup').value,
        instagram: document.getElementById('edit-instagram').value,
        youtube: document.getElementById('edit-youtube').value,
        website: document.getElementById('edit-website').value,
        profile_visibility: document.getElementById('edit-profile-visibility').value,
        show_real_name: document.getElementById('edit-show-real-name').checked,
        show_location: document.getElementById('edit-show-location').checked
    };
    
    const saveButton = document.querySelector('#edit-modal .btn-primary');
    const progressArea = document.getElementById('save-progress');
    const progressBar = document.getElementById('save-progress-bar');
    
    // Show progress
    saveButton.disabled = true;
    saveButton.innerHTML = '<span class="loading loading-spinner loading-sm mr-2"></span>Saving...';
    progressArea.classList.remove('hidden');
    
    // Simulate progress for visual feedback
    let progress = 0;
    const progressInterval = setInterval(() => {
        progress += 10;
        progressBar.value = Math.min(progress, 90);
    }, 100);
    
    // Save each field
    const promises = Object.entries(formData).map(([field, value]) => {
        return fetch('{% url "profiles:update_profile_api" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                field: field,
                value: value
            })
        }).then(response => response.json());
    });
    
    Promise.all(promises)
        .then(results => {
            clearInterval(progressInterval);
            progressBar.value = 100;
            
            // Check for errors
            const errors = results.filter(result => !result.success);
            if (errors.length > 0) {
                alert('Some changes could not be saved: ' + errors.map(e => e.error).join(', '));
            } else {
                showToast('Profile updated successfully!', 'success');
                closeEditModal();
                // Reload the page to show updated content
                setTimeout(() => {
                    location.reload();
                }, 1000);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while saving changes.');
        })
        .finally(() => {
            clearInterval(progressInterval);
            saveButton.disabled = false;
            saveButton.innerHTML = '<i class="fas fa-save mr-2"></i>Save Changes';
            progressArea.classList.add('hidden');
            progressBar.value = 0;
        });
}

// Close edit modal
function closeEditModal() {
    const modal = document.getElementById('edit-modal');
    modal.close();
    
    // Reset progress indicators
    document.getElementById('save-progress').classList.add('hidden');
    document.getElementById('save-progress-bar').value = 0;
}

// Initialize modal when opened
document.getElementById('edit-modal').addEventListener('show', function() {
    // Update character counters
    updateCharCounter('bio');
    updateCharCounter('setup');
    updateSkillDisplay();
});

// Auto-save draft functionality (optional)
let draftTimeout;
function saveDraft() {
    clearTimeout(draftTimeout);
    draftTimeout = setTimeout(() => {
        const formData = {
            display_name: document.getElementById('edit-display-name').value,
            bio: document.getElementById('edit-bio').value,
            // ... other fields
        };
        
        localStorage.setItem('profile_edit_draft', JSON.stringify(formData));
    }, 2000);
}

// Load draft on modal open
function loadDraft() {
    const draft = localStorage.getItem('profile_edit_draft');
    if (draft) {
        try {
            const data = JSON.parse(draft);
            Object.entries(data).forEach(([field, value]) => {
                const element = document.getElementById(`edit-${field.replace('_', '-')}`);
                if (element) {
                    if (element.type === 'checkbox') {
                        element.checked = value;
                    } else {
                        element.value = value;
                    }
                }
            });
        } catch (e) {
            console.error('Error loading draft:', e);
        }
    }
}

// Clear draft on successful save
function clearDraft() {
    localStorage.removeItem('profile_edit_draft');
}

// Add auto-save listeners
document.querySelectorAll('#quick-edit-form input, #quick-edit-form textarea, #quick-edit-form select').forEach(element => {
    element.addEventListener('input', saveDraft);
});
</script>
