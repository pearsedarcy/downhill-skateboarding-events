<!-- Avatar Upload Modal -->
<dialog id="avatar-modal" class="modal">
    <div class="modal-box max-w-md">
        <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
            <i class="fas fa-camera text-primary"></i>
            Update Profile Photo
        </h3>
        
        <!-- Current Avatar Preview -->
        <div class="text-center mb-6">
            <div class="avatar">
                <div class="w-24 h-24 rounded-full ring ring-primary ring-offset-base-100 ring-offset-2">
                    {% if profile.avatar %}
                        <img src="{{ profile.avatar.url }}" alt="Current avatar" id="current-avatar-preview">
                    {% else %}
                        <div class="w-24 h-24 rounded-full bg-gradient-to-br from-primary to-secondary flex items-center justify-center" id="current-avatar-preview">
                            <i class="fas fa-user text-2xl text-white"></i>
                        </div>
                    {% endif %}
                </div>
            </div>
            <p class="text-sm text-base-content/70 mt-2">Current profile photo</p>
        </div>
        
        <!-- Upload Form -->
        <form id="avatar-upload-form" enctype="multipart/form-data" class="space-y-4">
            {% csrf_token %}
            
            <!-- File Input -->
            <div class="form-control">
                <label class="label">
                    <span class="label-text font-semibold">Choose new photo</span>
                </label>
                <input type="file" 
                       name="avatar" 
                       id="avatar-input" 
                       class="file-input file-input-bordered w-full"
                       accept="image/*"
                       onchange="previewAvatar(this)">
                <label class="label">
                    <span class="label-text-alt text-base-content/60">
                        JPG, PNG, or GIF. Max size: 5MB. Recommended: Square image, 400x400px or larger.
                    </span>
                </label>
            </div>
            
            <!-- Preview Area -->
            <div id="preview-area" class="hidden">
                <div class="text-center">
                    <div class="avatar">
                        <div class="w-24 h-24 rounded-full ring ring-accent ring-offset-base-100 ring-offset-2">
                            <img id="avatar-preview" src="" alt="Preview" class="rounded-full">
                        </div>
                    </div>
                    <p class="text-sm text-accent mt-2">New profile photo preview</p>
                </div>
            </div>
            
            <!-- Upload Progress -->
            <div id="upload-progress" class="hidden">
                <div class="flex items-center gap-2 mb-2">
                    <span class="loading loading-spinner loading-sm"></span>
                    <span class="text-sm">Uploading...</span>
                </div>
                <progress class="progress progress-primary w-full" value="0" max="100" id="progress-bar"></progress>
            </div>
            
            <!-- Tips -->
            <div class="alert alert-info">
                <i class="fas fa-lightbulb"></i>
                <div class="text-sm">
                    <strong>Tips for a great profile photo:</strong>
                    <ul class="list-disc list-inside mt-2 space-y-1">
                        <li>Use a clear, well-lit photo</li>
                        <li>Square images work best</li>
                        <li>Show your face or skating gear</li>
                        <li>Avoid blurry or dark images</li>
                    </ul>
                </div>
            </div>
        </form>
        
        <!-- Modal Actions -->
        <div class="modal-action">
            <form method="dialog">
                <button class="btn" type="button" onclick="closeAvatarModal()">Cancel</button>
            </form>
            <button class="btn btn-primary" id="upload-btn" onclick="uploadAvatar()" disabled>
                <i class="fas fa-upload mr-2"></i>
                Upload Photo
            </button>
            {% if profile.avatar %}
                <button class="btn btn-error btn-outline" onclick="removeAvatar()">
                    <i class="fas fa-trash mr-2"></i>
                    Remove
                </button>
            {% endif %}
        </div>
    </div>
    
    <!-- Close modal when clicking outside -->
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>

<script>
let selectedFile = null;

function previewAvatar(input) {
    const file = input.files[0];
    const uploadBtn = document.getElementById('upload-btn');
    const previewArea = document.getElementById('preview-area');
    const preview = document.getElementById('avatar-preview');
    
    if (file) {
        // Validate file
        const maxSize = 5 * 1024 * 1024; // 5MB
        const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
        
        if (file.size > maxSize) {
            alert('File size must be less than 5MB');
            input.value = '';
            return;
        }
        
        if (!allowedTypes.includes(file.type)) {
            alert('Please select a valid image file (JPG, PNG, GIF, or WebP)');
            input.value = '';
            return;
        }
        
        // Preview the image
        const reader = new FileReader();
        reader.onload = function(e) {
            preview.src = e.target.result;
            previewArea.classList.remove('hidden');
            uploadBtn.disabled = false;
            selectedFile = file;
        };
        reader.readAsDataURL(file);
    } else {
        previewArea.classList.add('hidden');
        uploadBtn.disabled = true;
        selectedFile = null;
    }
}

function uploadAvatar() {
    if (!selectedFile) {
        alert('Please select an image first');
        return;
    }
    
    const formData = new FormData();
    formData.append('avatar', selectedFile);
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
    
    const uploadBtn = document.getElementById('upload-btn');
    const progressArea = document.getElementById('upload-progress');
    const progressBar = document.getElementById('progress-bar');
    
    // Show progress and disable button
    uploadBtn.disabled = true;
    uploadBtn.innerHTML = '<span class="loading loading-spinner loading-sm mr-2"></span>Uploading...';
    progressArea.classList.remove('hidden');
    
    // Create XMLHttpRequest for progress tracking
    const xhr = new XMLHttpRequest();
    
    // Track upload progress
    xhr.upload.addEventListener('progress', function(e) {
        if (e.lengthComputable) {
            const percentComplete = (e.loaded / e.total) * 100;
            progressBar.value = percentComplete;
        }
    });
    
    // Handle completion
    xhr.addEventListener('load', function() {
        if (xhr.status === 200) {
            try {
                const response = JSON.parse(xhr.responseText);
                if (response.success) {
                    // Update the avatar in the UI
                    const newAvatarUrl = response.avatar_url;
                    document.querySelectorAll('img[alt*="avatar"], img[alt*="Avatar"]').forEach(img => {
                        img.src = newAvatarUrl;
                    });
                    
                    // Close modal and show success message
                    closeAvatarModal();
                    showToast('Profile photo updated successfully!', 'success');
                } else {
                    alert('Error: ' + response.error);
                }
            } catch (e) {
                alert('Error processing response');
            }
        } else {
            alert('Upload failed. Please try again.');
        }
        
        // Reset UI
        uploadBtn.disabled = false;
        uploadBtn.innerHTML = '<i class="fas fa-upload mr-2"></i>Upload Photo';
        progressArea.classList.add('hidden');
        progressBar.value = 0;
    });
    
    // Handle errors
    xhr.addEventListener('error', function() {
        alert('Upload failed. Please check your connection and try again.');
        uploadBtn.disabled = false;
        uploadBtn.innerHTML = '<i class="fas fa-upload mr-2"></i>Upload Photo';
        progressArea.classList.add('hidden');
        progressBar.value = 0;
    });
    
    // Send the request
    xhr.open('POST', '{% url "profiles:upload_avatar_api" %}');
    xhr.send(formData);
}

function removeAvatar() {
    if (!confirm('Are you sure you want to remove your profile photo?')) {
        return;
    }
    
    fetch('{% url "profiles:upload_avatar_api" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            action: 'remove'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update UI to show default avatar
            document.querySelectorAll('img[alt*="avatar"], img[alt*="Avatar"]').forEach(img => {
                const defaultAvatar = document.createElement('div');
                defaultAvatar.className = 'w-full h-full bg-gradient-to-br from-primary to-secondary flex items-center justify-center rounded-full';
                defaultAvatar.innerHTML = '<i class="fas fa-user text-white"></i>';
                img.parentNode.replaceChild(defaultAvatar, img);
            });
            
            closeAvatarModal();
            showToast('Profile photo removed successfully!', 'success');
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while removing the photo.');
    });
}

function closeAvatarModal() {
    const modal = document.getElementById('avatar-modal');
    modal.close();
    
    // Reset form
    document.getElementById('avatar-upload-form').reset();
    document.getElementById('preview-area').classList.add('hidden');
    document.getElementById('upload-progress').classList.add('hidden');
    document.getElementById('upload-btn').disabled = true;
    selectedFile = null;
}

// Toast notification function
function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `alert alert-${type} fixed top-4 right-4 w-auto max-w-sm z-50 shadow-lg`;
    toast.innerHTML = `
        <div class="flex items-center gap-2">
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
            <span>${message}</span>
        </div>
    `;
    
    document.body.appendChild(toast);
    
    // Remove toast after 3 seconds
    setTimeout(() => {
        toast.remove();
    }, 3000);
}

// Handle drag and drop
const avatarInput = document.getElementById('avatar-input');
const modalBox = document.querySelector('#avatar-modal .modal-box');

['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
    modalBox.addEventListener(eventName, preventDefaults, false);
});

function preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
}

['dragenter', 'dragover'].forEach(eventName => {
    modalBox.addEventListener(eventName, highlight, false);
});

['dragleave', 'drop'].forEach(eventName => {
    modalBox.addEventListener(eventName, unhighlight, false);
});

function highlight(e) {
    modalBox.classList.add('ring-2', 'ring-primary', 'ring-offset-2');
}

function unhighlight(e) {
    modalBox.classList.remove('ring-2', 'ring-primary', 'ring-offset-2');
}

modalBox.addEventListener('drop', handleDrop, false);

function handleDrop(e) {
    const dt = e.dataTransfer;
    const files = dt.files;
    
    if (files.length > 0) {
        avatarInput.files = files;
        previewAvatar(avatarInput);
    }
}
</script>
